<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gateway API + TLS + cert-manager Guide | Homelab GitOps</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-orange: #d29922;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
            --border-color: #30363d;
            --code-bg: #1a1f26;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 3rem 0;
            margin-bottom: 2rem;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header p {
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        .toc {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .toc h2 {
            color: var(--accent-blue);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .toc ul {
            list-style: none;
        }

        .toc li {
            margin: 0.5rem 0;
        }

        .toc a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .toc a:hover {
            color: var(--accent-blue);
        }

        .toc .sub-item {
            margin-left: 1.5rem;
            font-size: 0.9rem;
        }

        section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        h2 {
            color: var(--accent-blue);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        h3 {
            color: var(--accent-green);
            margin: 1.5rem 0 1rem;
            font-size: 1.3rem;
        }

        h4 {
            color: var(--accent-orange);
            margin: 1rem 0 0.5rem;
            font-size: 1.1rem;
        }

        p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        code {
            background: var(--code-bg);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            color: var(--accent-orange);
        }

        pre {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 1rem 0;
            position: relative;
        }

        pre code {
            background: none;
            padding: 0;
            color: var(--text-primary);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .code-header {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-header + pre {
            border-radius: 0 0 8px 8px;
            margin-top: 0;
        }

        .language-tag {
            background: var(--accent-purple);
            color: var(--bg-primary);
            padding: 0.1rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .note {
            background: rgba(88, 166, 255, 0.1);
            border-left: 4px solid var(--accent-blue);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .note h4 {
            color: var(--accent-blue);
            margin-top: 0;
        }

        .warning {
            background: rgba(210, 153, 34, 0.1);
            border-left: 4px solid var(--accent-orange);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .warning h4 {
            color: var(--accent-orange);
            margin-top: 0;
        }

        .tip {
            background: rgba(63, 185, 80, 0.1);
            border-left: 4px solid var(--accent-green);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .tip h4 {
            color: var(--accent-green);
            margin-top: 0;
        }

        .error {
            background: rgba(248, 81, 73, 0.1);
            border-left: 4px solid var(--accent-red);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .error h4 {
            color: var(--accent-red);
            margin-top: 0;
        }

        .architecture-diagram {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.75rem;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre;
            color: var(--text-primary);
            margin: 1rem 0;
        }

        .step {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid var(--accent-purple);
        }

        .step-number {
            background: var(--accent-purple);
            color: var(--bg-primary);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .checklist {
            list-style: none;
            margin: 1rem 0;
        }

        .checklist li {
            padding: 0.5rem 0;
            padding-left: 2rem;
            position: relative;
        }

        .checklist li::before {
            content: "â˜";
            position: absolute;
            left: 0;
            color: var(--accent-green);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            text-align: left;
        }

        th {
            background: var(--bg-tertiary);
            color: var(--accent-blue);
        }

        td {
            color: var(--text-secondary);
        }

        .flow-arrow {
            color: var(--accent-green);
            font-size: 1.5rem;
            text-align: center;
            margin: 0.5rem 0;
        }

        .badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .badge-blue { background: var(--accent-blue); color: var(--bg-primary); }
        .badge-green { background: var(--accent-green); color: var(--bg-primary); }
        .badge-orange { background: var(--accent-orange); color: var(--bg-primary); }
        .badge-purple { background: var(--accent-purple); color: var(--bg-primary); }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
            
            section {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸ” Gateway API + TLS + cert-manager Guide</h1>
            <p>Complete guide for exposing applications with HTTPS using Kubernetes Gateway API, Cilium, and cert-manager</p>
        </div>
    </header>

    <div class="container">
        <!-- Table of Contents -->
        <nav class="toc">
            <h2>ğŸ“‹ Table of Contents</h2>
            <ul>
                <li><a href="#architecture">1. Architecture Overview</a></li>
                <li><a href="#how-it-works">2. How It Works</a>
                    <ul>
                        <li class="sub-item"><a href="#gateway-api">2.1 Gateway API Concepts</a></li>
                        <li class="sub-item"><a href="#cert-manager">2.2 cert-manager Integration</a></li>
                        <li class="sub-item"><a href="#tls-flow">2.3 TLS Termination Flow</a></li>
                    </ul>
                </li>
                <li><a href="#current-setup">3. Current Infrastructure Setup</a></li>
                <li><a href="#deploy-new-app">4. Deploy New Application with HTTPS</a>
                    <ul>
                        <li class="sub-item"><a href="#step-namespace">4.1 Create Namespace</a></li>
                        <li class="sub-item"><a href="#step-deployment">4.2 Create Deployment</a></li>
                        <li class="sub-item"><a href="#step-service">4.3 Create Service</a></li>
                        <li class="sub-item"><a href="#step-gateway-listener">4.4 Add Gateway Listener</a></li>
                        <li class="sub-item"><a href="#step-httproute">4.5 Create HTTPRoute</a></li>
                        <li class="sub-item"><a href="#step-kustomization">4.6 Update Kustomization</a></li>
                    </ul>
                </li>
                <li><a href="#cert-manager-deep">5. cert-manager Deep Dive</a>
                    <ul>
                        <li class="sub-item"><a href="#cert-types">5.1 Certificate Types</a></li>
                        <li class="sub-item"><a href="#issuer-config">5.2 ClusterIssuer Configuration</a></li>
                        <li class="sub-item"><a href="#manual-cert">5.3 Manual Certificate Creation</a></li>
                        <li class="sub-item"><a href="#lets-encrypt">5.4 Let's Encrypt Setup</a></li>
                    </ul>
                </li>
                <li><a href="#troubleshooting">6. Troubleshooting Guide</a></li>
                <li><a href="#commands-reference">7. Command Reference</a></li>
            </ul>
        </nav>

        <!-- Architecture Overview -->
        <section id="architecture">
            <h2>ğŸ—ï¸ 1. Architecture Overview</h2>
            <p>This homelab uses a GitOps approach with ArgoCD managing Kubernetes resources deployed on Talos Linux nodes, with Cilium providing networking and Gateway API implementation.</p>
            
            <div class="architecture-diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              EXTERNAL NETWORK (192.168.1.0/24)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Gateway-Int  â”‚                         â”‚   Gateway-Ext    â”‚
            â”‚ 192.168.1.101 â”‚                         â”‚  192.168.1.102   â”‚
            â”‚   (internal)  â”‚                         â”‚    (external)    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                                          â”‚
                    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚    â”‚     Cilium L2 Announcements     â”‚   â”‚
                    â”‚    â”‚    (LoadBalancer IP Handling)   â”‚   â”‚
                    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚                                          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                        â”‚                        â”‚
            â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
            â”‚     â”‚         TLS TERMINATION             â”‚     â”‚
            â”‚     â”‚    (cert-manager certificates)      â”‚     â”‚
            â”‚     â”‚                                     â”‚     â”‚
            â”‚     â”‚  argocd-tls-secret (self-signed)   â”‚     â”‚
            â”‚     â”‚  myapp-tls-secret (self-signed)    â”‚     â”‚
            â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
            â”‚                        â”‚                        â”‚
            â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
            â”‚     â”‚          HTTPRoute Rules            â”‚     â”‚
            â”‚     â”‚                                     â”‚     â”‚
            â”‚     â”‚  argocd.domain.uk â†’ argocd:80      â”‚     â”‚
            â”‚     â”‚  myapp.domain.uk  â†’ myapp:8080     â”‚     â”‚
            â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
            â”‚                        â”‚                        â”‚
            â”‚    KUBERNETES CLUSTER  â”‚                        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                â”‚                                    â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”
â”‚  talos-control-01  â”‚    â”‚   talos-worker-01    â”‚    â”‚    talos-worker-02   â”‚
â”‚   192.168.1.112    â”‚    â”‚    192.168.1.113     â”‚    â”‚     192.168.1.114    â”‚
â”‚   (control-plane)  â”‚    â”‚      (worker)        â”‚    â”‚       (worker)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>

            <h3>Key Components</h3>
            <table>
                <tr>
                    <th>Component</th>
                    <th>Purpose</th>
                    <th>Version/Config</th>
                </tr>
                <tr>
                    <td><span class="badge badge-blue">Talos Linux</span></td>
                    <td>Immutable Kubernetes OS</td>
                    <td>v1.11.0</td>
                </tr>
                <tr>
                    <td><span class="badge badge-green">Cilium</span></td>
                    <td>CNI + Gateway API + L2 Announcements</td>
                    <td>v1.18.1</td>
                </tr>
                <tr>
                    <td><span class="badge badge-orange">cert-manager</span></td>
                    <td>TLS certificate management</td>
                    <td>v1.18.2</td>
                </tr>
                <tr>
                    <td><span class="badge badge-purple">ArgoCD</span></td>
                    <td>GitOps continuous delivery</td>
                    <td>Helm chart</td>
                </tr>
            </table>
        </section>

        <!-- How It Works -->
        <section id="how-it-works">
            <h2>âš™ï¸ 2. How It Works</h2>
            
            <h3 id="gateway-api">2.1 Gateway API Concepts</h3>
            <p>Gateway API is the next-generation Kubernetes API for routing traffic. It separates concerns between infrastructure providers and application developers:</p>
            
            <table>
                <tr>
                    <th>Resource</th>
                    <th>Who Manages</th>
                    <th>Purpose</th>
                </tr>
                <tr>
                    <td><code>GatewayClass</code></td>
                    <td>Infrastructure Admin</td>
                    <td>Defines the controller (Cilium) that handles Gateways</td>
                </tr>
                <tr>
                    <td><code>Gateway</code></td>
                    <td>Cluster Admin</td>
                    <td>Defines entry points (IPs, ports, TLS) into the cluster</td>
                </tr>
                <tr>
                    <td><code>HTTPRoute</code></td>
                    <td>Application Developer</td>
                    <td>Routes traffic from Gateway to Services</td>
                </tr>
            </table>

            <h3 id="cert-manager">2.2 cert-manager Integration</h3>
            <p>cert-manager automates TLS certificate management. When a Gateway references a certificate, cert-manager:</p>
            
            <ol style="color: var(--text-secondary); margin-left: 1.5rem;">
                <li>Detects the certificate request via annotations</li>
                <li>Creates a <code>Certificate</code> resource</li>
                <li>Generates the certificate using the specified <code>ClusterIssuer</code></li>
                <li>Stores the certificate in a Kubernetes <code>Secret</code></li>
                <li>Gateway uses the Secret for TLS termination</li>
            </ol>

            <div class="note">
                <h4>ğŸ“ Note: Gateway API Integration</h4>
                <p>cert-manager has native Gateway API support. Adding the annotation <code>cert-manager.io/cluster-issuer: &lt;issuer-name&gt;</code> to a Gateway automatically provisions certificates for HTTPS listeners.</p>
            </div>

            <h3 id="tls-flow">2.3 TLS Termination Flow</h3>
            <div class="architecture-diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     HTTPS (443)      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     HTTP (80)      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚    Gateway    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚   Service   â”‚
â”‚             â”‚   encrypted TLS      â”‚ (terminates)  â”‚   plain HTTP       â”‚   (Pod)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â”‚ uses
                                            â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  TLS Secret   â”‚
                                    â”‚ (certificate) â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â–²
                                            â”‚ creates
                                            â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ cert-manager  â”‚
                                    â”‚ ClusterIssuer â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>

            <div class="warning">
                <h4>âš ï¸ Important: Backend Port</h4>
                <p>Since TLS is terminated at the Gateway, your HTTPRoute must route to the <strong>HTTP port</strong> of your service (usually 80 or 8080), NOT the HTTPS port. The traffic between Gateway and Pod is unencrypted within the cluster.</p>
            </div>
        </section>

        <!-- Current Setup -->
        <section id="current-setup">
            <h2>ğŸ“¦ 3. Current Infrastructure Setup</h2>
            
            <h3>IP Pool Configuration</h3>
            <p>Cilium L2 announcements provide LoadBalancer IPs from this pool:</p>
            
            <div class="code-header">
                <span>apps/infrastructure/networking/gateway/ip-pool.yaml</span>
                <span class="language-tag">YAML</span>
            </div>
            <pre><code>apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: main-pool
  namespace: gateway
spec:
  blocks:
    - start: 192.168.1.100
      stop: 192.168.1.115</code></pre>

            <h3>Gateway Configuration (with TLS)</h3>
            <div class="code-header">
                <span>apps/infrastructure/networking/gateway/gw-internal.yaml</span>
                <span class="language-tag">YAML</span>
            </div>
            <pre><code>apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: gateway-internal
  namespace: gateway
  annotations:
    # This tells cert-manager to provision certificates
    cert-manager.io/cluster-issuer: selfsigned-issuer
spec:
  gatewayClassName: cilium
  addresses:
    - value: 192.168.1.101
  listeners:
    # HTTP listener - catches all HTTP traffic (wildcard)
    - name: http
      protocol: HTTP
      port: 80
      hostname: "*.starbasestudio.uk"
      allowedRoutes:
        namespaces:
          from: All
    
    # HTTPS listener - specific hostname with TLS termination
    - name: https
      protocol: HTTPS
      port: 443
      hostname: argocd.starbasestudio.uk
      tls:
        mode: Terminate
        certificateRefs:
          - name: argocd-tls-secret
            kind: Secret
      allowedRoutes:
        namespaces:
          from: All</code></pre>

            <h3>ClusterIssuer (Self-Signed)</h3>
            <div class="code-header">
                <span>apps/infrastructure/controllers/cert-manager/cluster-issuer-selfsigned.yaml</span>
                <span class="language-tag">YAML</span>
            </div>
            <pre><code>apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-issuer
spec:
  selfSigned: {}</code></pre>

            <h3>HTTPRoute for ArgoCD</h3>
            <div class="code-header">
                <span>apps/infrastructure/controllers/argocd/http-route.yaml</span>
                <span class="language-tag">YAML</span>
            </div>
            <pre><code>apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: argocd-http
  namespace: argocd
spec:
  parentRefs:
    - name: gateway-internal
      namespace: gateway
      sectionName: https  # Reference the HTTPS listener
    - name: gateway-external
      namespace: gateway
      sectionName: https
  hostnames:
    - argocd.starbasestudio.uk
  rules:
    - backendRefs:
        - name: argocd-server
          port: 80  # HTTP port (TLS terminated at Gateway)</code></pre>
        </section>

        <!-- Deploy New App -->
        <section id="deploy-new-app">
            <h2>ğŸš€ 4. Deploy New Application with HTTPS</h2>
            <p>Follow these steps to deploy a new application with HTTPS enabled. We'll use a sample app called "myapp" as an example.</p>

            <div class="step" id="step-namespace">
                <h3><span class="step-number">1</span> Create Namespace</h3>
                <div class="code-header">
                    <span>my-apps/myapp/namespace.yaml</span>
                    <span class="language-tag">YAML</span>
                </div>
                <pre><code>apiVersion: v1
kind: Namespace
metadata:
  name: myapp
  labels:
    app.kubernetes.io/name: myapp</code></pre>
            </div>

            <div class="step" id="step-deployment">
                <h3><span class="step-number">2</span> Create Deployment</h3>
                <div class="code-header">
                    <span>my-apps/myapp/deployment.yaml</span>
                    <span class="language-tag">YAML</span>
                </div>
                <pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
  namespace: myapp
  labels:
    app: myapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
        - name: myapp
          image: nginx:alpine  # Replace with your image
          ports:
            - containerPort: 80
              name: http
          resources:
            requests:
              memory: "64Mi"
              cpu: "100m"
            limits:
              memory: "128Mi"
              cpu: "200m"</code></pre>
            </div>

            <div class="step" id="step-service">
                <h3><span class="step-number">3</span> Create Service</h3>
                <div class="code-header">
                    <span>my-apps/myapp/service.yaml</span>
                    <span class="language-tag">YAML</span>
                </div>
                <pre><code>apiVersion: v1
kind: Service
metadata:
  name: myapp
  namespace: myapp
  labels:
    app: myapp
spec:
  selector:
    app: myapp
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP</code></pre>
            </div>

            <div class="step" id="step-gateway-listener">
                <h3><span class="step-number">4</span> Add HTTPS Listener to Gateway</h3>
                <p>Add a new listener for your app's hostname to the Gateway. This enables TLS termination for your domain.</p>
                
                <div class="warning">
                    <h4>âš ï¸ Add to BOTH Gateways</h4>
                    <p>If you want the app accessible via both internal and external Gateways, add the listener to both <code>gw-internal.yaml</code> and <code>gw-external.yaml</code>.</p>
                </div>

                <div class="code-header">
                    <span>apps/infrastructure/networking/gateway/gw-internal.yaml (add this listener)</span>
                    <span class="language-tag">YAML</span>
                </div>
                <pre><code>    # Add this under spec.listeners:
    - name: https-myapp
      protocol: HTTPS
      port: 443
      hostname: myapp.starbasestudio.uk
      tls:
        mode: Terminate
        certificateRefs:
          - name: myapp-tls-secret
            kind: Secret
      allowedRoutes:
        namespaces:
          from: All</code></pre>

                <div class="tip">
                    <h4>ğŸ’¡ How cert-manager Creates the Certificate</h4>
                    <p>When the Gateway has the annotation <code>cert-manager.io/cluster-issuer: selfsigned-issuer</code> and references a secret that doesn't exist, cert-manager automatically creates a <code>Certificate</code> resource and provisions the TLS secret.</p>
                </div>
            </div>

            <div class="step" id="step-httproute">
                <h3><span class="step-number">5</span> Create HTTPRoute</h3>
                <div class="code-header">
                    <span>my-apps/myapp/httproute.yaml</span>
                    <span class="language-tag">YAML</span>
                </div>
                <pre><code>apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: myapp-route
  namespace: myapp
spec:
  parentRefs:
    # Reference internal gateway HTTPS listener
    - name: gateway-internal
      namespace: gateway
      sectionName: https-myapp
    # Reference external gateway HTTPS listener  
    - name: gateway-external
      namespace: gateway
      sectionName: https-myapp
  hostnames:
    - myapp.starbasestudio.uk
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: myapp
          port: 80  # Service HTTP port (NOT 443!)</code></pre>

                <div class="error">
                    <h4>âŒ Common Mistake: Wrong Backend Port</h4>
                    <p>Do NOT use port 443 in backendRefs! TLS is terminated at the Gateway, so traffic to your service is plain HTTP. Using 443 will cause "connection refused" errors.</p>
                </div>
            </div>

            <div class="step" id="step-kustomization">
                <h3><span class="step-number">6</span> Create Kustomization</h3>
                <div class="code-header">
                    <span>my-apps/myapp/kustomization.yaml</span>
                    <span class="language-tag">YAML</span>
                </div>
                <pre><code>apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: myapp
resources:
  - namespace.yaml
  - deployment.yaml
  - service.yaml
  - httproute.yaml</code></pre>
            </div>

            <div class="step">
                <h3><span class="step-number">7</span> Commit and Push</h3>
                <p>ArgoCD will automatically sync the changes:</p>
                <pre><code>git add my-apps/myapp/
git commit -m "feat: add myapp with HTTPS"
git push origin main</code></pre>
            </div>

            <div class="step">
                <h3><span class="step-number">8</span> Configure DNS</h3>
                <p>Add DNS record or /etc/hosts entry:</p>
                <pre><code># For testing (add to /etc/hosts on your machine)
192.168.1.101 myapp.starbasestudio.uk

# Or use curl with --resolve
curl -k --resolve myapp.starbasestudio.uk:443:192.168.1.101 https://myapp.starbasestudio.uk</code></pre>
            </div>
        </section>

        <!-- cert-manager Deep Dive -->
        <section id="cert-manager-deep">
            <h2>ğŸ” 5. cert-manager Deep Dive</h2>

            <h3 id="cert-types">5.1 Certificate Types</h3>
            <table>
                <tr>
                    <th>Type</th>
                    <th>Use Case</th>
                    <th>Browser Warning?</th>
                </tr>
                <tr>
                    <td><span class="badge badge-orange">Self-Signed</span></td>
                    <td>Development, internal homelab</td>
                    <td>Yes âš ï¸</td>
                </tr>
                <tr>
                    <td><span class="badge badge-green">Let's Encrypt</span></td>
                    <td>Production, public-facing</td>
                    <td>No âœ…</td>
                </tr>
                <tr>
                    <td><span class="badge badge-blue">Private CA</span></td>
                    <td>Enterprise, internal PKI</td>
                    <td>No (if CA trusted)</td>
                </tr>
            </table>

            <h3 id="issuer-config">5.2 ClusterIssuer Configurations</h3>
            
            <h4>Self-Signed Issuer</h4>
            <div class="code-header">
                <span>Self-signed ClusterIssuer</span>
                <span class="language-tag">YAML</span>
            </div>
            <pre><code>apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-issuer
spec:
  selfSigned: {}</code></pre>

            <h4>CA Issuer (with your own CA)</h4>
            <div class="code-header">
                <span>CA ClusterIssuer</span>
                <span class="language-tag">YAML</span>
            </div>
            <pre><code># First create a root CA certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: root-ca
  namespace: cert-manager
spec:
  isCA: true
  commonName: "Homelab Root CA"
  secretName: root-ca-secret
  duration: 87600h  # 10 years
  privateKey:
    algorithm: RSA
    size: 4096
  issuerRef:
    name: selfsigned-issuer
    kind: ClusterIssuer

---
# Then create CA issuer using the root CA
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: ca-issuer
spec:
  ca:
    secretName: root-ca-secret</code></pre>

            <h3 id="manual-cert">5.3 Manual Certificate Creation</h3>
            <p>You can create certificates manually (instead of relying on Gateway annotations):</p>
            
            <div class="code-header">
                <span>Manual Certificate resource</span>
                <span class="language-tag">YAML</span>
            </div>
            <pre><code>apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: myapp-certificate
  namespace: gateway  # Must be in same namespace as Gateway
spec:
  secretName: myapp-tls-secret
  
  # Certificate validity duration
  duration: 2160h   # 90 days
  renewBefore: 360h # Renew 15 days before expiry
  
  # Subject information
  subject:
    organizations:
      - "My Homelab"
  
  # Common name (deprecated but still used)
  commonName: myapp.starbasestudio.uk
  
  # Subject Alternative Names (SANs) - more important
  dnsNames:
    - myapp.starbasestudio.uk
    - "*.myapp.starbasestudio.uk"  # Wildcard
  
  # Private key configuration
  privateKey:
    algorithm: RSA
    size: 2048
    encoding: PKCS1
  
  # Which issuer to use
  issuerRef:
    name: selfsigned-issuer
    kind: ClusterIssuer
    group: cert-manager.io</code></pre>

            <h3 id="lets-encrypt">5.4 Let's Encrypt Setup (Production)</h3>
            <p>For publicly accessible services, use Let's Encrypt for free trusted certificates:</p>

            <div class="code-header">
                <span>Let's Encrypt Staging (for testing)</span>
                <span class="language-tag">YAML</span>
            </div>
            <pre><code>apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    # Staging server (use for testing to avoid rate limits)
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: your-email@example.com
    privateKeySecretRef:
      name: letsencrypt-staging-key
    solvers:
      # HTTP-01 challenge using Gateway API
      - http01:
          gatewayHTTPRoute:
            parentRefs:
              - name: gateway-external
                namespace: gateway
                kind: Gateway</code></pre>

            <div class="code-header">
                <span>Let's Encrypt Production</span>
                <span class="language-tag">YAML</span>
            </div>
            <pre><code>apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    # Production server
    server: https://acme-v02.api.letsencrypt.org/directory
    email: your-email@example.com
    privateKeySecretRef:
      name: letsencrypt-prod-key
    solvers:
      # HTTP-01 challenge
      - http01:
          gatewayHTTPRoute:
            parentRefs:
              - name: gateway-external
                namespace: gateway
                kind: Gateway</code></pre>

            <div class="note">
                <h4>ğŸ“ Let's Encrypt Requirements</h4>
                <ul style="color: var(--text-secondary); margin-left: 1rem;">
                    <li>Domain must be publicly accessible on port 80</li>
                    <li>DNS must resolve to your public IP</li>
                    <li>Use staging first to avoid rate limits</li>
                    <li>HTTP-01 challenge requires port 80 open to internet</li>
                </ul>
            </div>

            <h4>Using Let's Encrypt with Gateway</h4>
            <div class="code-header">
                <span>Gateway with Let's Encrypt annotation</span>
                <span class="language-tag">YAML</span>
            </div>
            <pre><code>apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: gateway-external
  namespace: gateway
  annotations:
    # Use Let's Encrypt for this gateway
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  gatewayClassName: cilium
  listeners:
    - name: https-myapp
      protocol: HTTPS
      port: 443
      hostname: myapp.yourdomain.com
      tls:
        mode: Terminate
        certificateRefs:
          - name: myapp-letsencrypt-tls
            kind: Secret</code></pre>
        </section>

        <!-- Troubleshooting -->
        <section id="troubleshooting">
            <h2>ğŸ”§ 6. Troubleshooting Guide</h2>

            <h3>Problem: "Can't reach this page" / Connection refused</h3>
            <div class="step">
                <h4>Step 1: Verify Gateway IP is reachable</h4>
                <pre><code># Check if Gateway has an IP
kubectl get gateway -n gateway

# Ping the Gateway IP
ping 192.168.1.101

# Check TCP connectivity
nc -vz 192.168.1.101 443</code></pre>
            </div>

            <div class="step">
                <h4>Step 2: Check Gateway listeners</h4>
                <pre><code># List all listeners
kubectl get gateway -n gateway gateway-internal -o jsonpath='{range .spec.listeners[*]}{.name}{" â†’ "}{.hostname}:{.port}{"\n"}{end}'

# Check listener status
kubectl describe gateway gateway-internal -n gateway | grep -A 20 "Listeners:"</code></pre>
            </div>

            <div class="step">
                <h4>Step 3: Verify HTTPRoute attachment</h4>
                <pre><code># Check HTTPRoute status
kubectl describe httproute &lt;route-name&gt; -n &lt;namespace&gt;

# Look for "Accepted: True" and "ResolvedRefs: True"
# Common errors:
#   - "No matching listener" = wrong sectionName
#   - "BackendNotFound" = service doesn't exist</code></pre>
            </div>

            <div class="step">
                <h4>Step 4: Test with curl</h4>
                <pre><code># Test HTTPS (skip cert verification for self-signed)
curl -vk --resolve myapp.starbasestudio.uk:443:192.168.1.101 https://myapp.starbasestudio.uk

# Test HTTP
curl -v --resolve myapp.starbasestudio.uk:80:192.168.1.101 http://myapp.starbasestudio.uk</code></pre>
            </div>

            <div class="step">
                <h4>Step 5: Check backend service</h4>
                <pre><code># Verify service exists and has endpoints
kubectl get svc -n &lt;namespace&gt;
kubectl get endpoints -n &lt;namespace&gt;

# Port forward to test service directly
kubectl port-forward svc/myapp 8080:80 -n myapp
curl http://localhost:8080</code></pre>
            </div>

            <h3>Problem: "No matching listener with sectionName"</h3>
            <div class="error">
                <h4>Cause</h4>
                <p>HTTPRoute's <code>sectionName</code> doesn't match any listener name in the Gateway.</p>
            </div>
            <pre><code># Check listener names
kubectl get gateway gateway-internal -n gateway -o jsonpath='{range .spec.listeners[*]}{.name}{"\n"}{end}'

# HTTPRoute sectionName must exactly match one of these names</code></pre>

            <h3>Problem: Certificate not created</h3>
            <pre><code># Check if Certificate resource exists
kubectl get certificate -A

# Check cert-manager logs
kubectl logs -n cert-manager deployment/cert-manager

# Check if ClusterIssuer is ready
kubectl describe clusterissuer selfsigned-issuer

# Manually check certificate secret
kubectl get secret -n gateway | grep tls</code></pre>

            <h3>Problem: Changes not applying (Cilium cache)</h3>
            <p>After Gateway changes, Cilium may have stale BPF mappings:</p>
            <pre><code># Restart Cilium to flush BPF maps
kubectl rollout restart daemonset/cilium -n kube-system

# Wait for rollout
kubectl rollout status daemonset/cilium -n kube-system

# Verify L2 announcements are working
kubectl exec -n kube-system ds/cilium -- cilium-dbg bpf lb list | grep 192.168.1</code></pre>

            <h3>Quick Diagnostic Commands</h3>
            <div class="code-header">
                <span>Copy-paste diagnostic script</span>
                <span class="language-tag">BASH</span>
            </div>
            <pre><code>#!/bin/bash
# Quick diagnostic for Gateway API issues

echo "=== Gateways ==="
kubectl get gateway -A

echo -e "\n=== HTTPRoutes ==="
kubectl get httproute -A

echo -e "\n=== Gateway IPs ==="
kubectl get svc -n gateway -l gateway.networking.k8s.io/gateway-name

echo -e "\n=== Certificates ==="
kubectl get certificate -A

echo -e "\n=== Certificate Secrets ==="
kubectl get secret -A | grep tls

echo -e "\n=== Recent cert-manager events ==="
kubectl get events -n cert-manager --sort-by='.lastTimestamp' | tail -10

echo -e "\n=== Cilium Status ==="
kubectl exec -n kube-system ds/cilium -- cilium-dbg status | head -20</code></pre>
        </section>

        <!-- Command Reference -->
        <section id="commands-reference">
            <h2>ğŸ“š 7. Command Reference</h2>

            <h3>Gateway Commands</h3>
            <table>
                <tr><th>Command</th><th>Description</th></tr>
                <tr><td><code>kubectl get gateway -A</code></td><td>List all gateways</td></tr>
                <tr><td><code>kubectl describe gateway &lt;name&gt; -n gateway</code></td><td>Detailed gateway info</td></tr>
                <tr><td><code>kubectl get httproute -A</code></td><td>List all HTTP routes</td></tr>
                <tr><td><code>kubectl describe httproute &lt;name&gt; -n &lt;ns&gt;</code></td><td>Route status and errors</td></tr>
            </table>

            <h3>cert-manager Commands</h3>
            <table>
                <tr><th>Command</th><th>Description</th></tr>
                <tr><td><code>kubectl get certificate -A</code></td><td>List all certificates</td></tr>
                <tr><td><code>kubectl get clusterissuer</code></td><td>List cluster issuers</td></tr>
                <tr><td><code>kubectl describe certificate &lt;name&gt;</code></td><td>Certificate status</td></tr>
                <tr><td><code>kubectl get secret &lt;name&gt; -o yaml</code></td><td>View TLS secret</td></tr>
                <tr><td><code>kubectl cert-manager status certificate &lt;name&gt;</code></td><td>Detailed cert status (requires kubectl plugin)</td></tr>
            </table>

            <h3>Cilium Commands</h3>
            <table>
                <tr><th>Command</th><th>Description</th></tr>
                <tr><td><code>kubectl exec -n kube-system ds/cilium -- cilium-dbg status</code></td><td>Cilium status</td></tr>
                <tr><td><code>kubectl exec -n kube-system ds/cilium -- cilium-dbg bpf lb list</code></td><td>Load balancer entries</td></tr>
                <tr><td><code>kubectl rollout restart ds/cilium -n kube-system</code></td><td>Restart Cilium (flush cache)</td></tr>
            </table>

            <h3>Testing Commands</h3>
            <table>
                <tr><th>Command</th><th>Description</th></tr>
                <tr><td><code>nc -vz &lt;ip&gt; &lt;port&gt;</code></td><td>Test TCP connectivity</td></tr>
                <tr><td><code>curl -vk https://&lt;url&gt;</code></td><td>Test HTTPS (ignore cert errors)</td></tr>
                <tr><td><code>curl --resolve host:port:ip https://host</code></td><td>Override DNS for testing</td></tr>
                <tr><td><code>openssl s_client -connect ip:443</code></td><td>View TLS certificate details</td></tr>
            </table>
        </section>

        <!-- Checklist -->
        <section>
            <h2>âœ… New App Deployment Checklist</h2>
            <ul class="checklist">
                <li>Create namespace.yaml</li>
                <li>Create deployment.yaml with correct image and ports</li>
                <li>Create service.yaml exposing HTTP port (80 or 8080)</li>
                <li>Add HTTPS listener to Gateway(s) with unique name</li>
                <li>Verify Gateway has cert-manager annotation</li>
                <li>Create httproute.yaml with correct sectionName</li>
                <li>HTTPRoute backendRefs uses HTTP port (NOT 443)</li>
                <li>Create kustomization.yaml including all resources</li>
                <li>Commit and push to git repository</li>
                <li>Wait for ArgoCD sync (or manual sync)</li>
                <li>Verify Certificate is created and Ready</li>
                <li>Configure DNS or /etc/hosts</li>
                <li>Test with curl -k</li>
            </ul>
        </section>
    </div>

    <footer>
        <p>Generated for Homelab GitOps Setup | Gateway API + Cilium + cert-manager</p>
        <p>Last updated: January 2026</p>
    </footer>
</body>
</html>