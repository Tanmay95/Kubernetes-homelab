apiVersion: apps/v1
kind: Deployment
metadata:
  name: firefly-iii
  namespace: firefly-iii
  labels:
    app.kubernetes.io/name: firefly-iii
    app.kubernetes.io/component: app
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: firefly-iii
  template:
    metadata:
      labels:
        app.kubernetes.io/name: firefly-iii
        app.kubernetes.io/component: app
    spec:
      initContainers:
        - name: wait-for-db
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z firefly-iii-db 5432; do echo waiting for database; sleep 2; done;']
      containers:
        - name: firefly-iii
          image: fireflyiii/core:latest
          ports:
            - containerPort: 8080
              name: http
          env:
            # Application settings
            - name: APP_ENV
              value: "production"
            - name: APP_DEBUG
              value: "false"
            - name: SITE_OWNER
              value: "admin@example.com"
            - name: APP_KEY
              valueFrom:
                secretKeyRef:
                  name: firefly-iii-secrets
                  key: APP_KEY
            - name: DEFAULT_LANGUAGE
              value: "en_US"
            - name: DEFAULT_LOCALE
              value: "equal"
            - name: TZ
              value: "America/Detroit"
            # Trusted proxies for gateway
            - name: TRUSTED_PROXIES
              value: "**"
            - name: APP_URL
              value: "http://localhost:8080"
            # Database settings
            - name: DB_CONNECTION
              value: "pgsql"
            - name: DB_HOST
              value: "firefly-iii-db"
            - name: DB_PORT
              value: "5432"
            - name: DB_DATABASE
              value: "firefly"
            - name: DB_USERNAME
              value: "firefly"
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: firefly-iii-secrets
                  key: DB_PASSWORD
            # Cron token for scheduled tasks
            - name: STATIC_CRON_TOKEN
              valueFrom:
                secretKeyRef:
                  name: firefly-iii-secrets
                  key: STATIC_CRON_TOKEN
            # Enable file uploads for CSV/PDF import
            - name: ALLOW_WEBHOOKS
              value: "true"
            - name: ENABLE_EXTERNAL_MAP
              value: "false"
            - name: ENABLE_EXTERNAL_RATES
              value: "true"
          volumeMounts:
            - name: upload-data
              mountPath: /var/www/html/storage/upload
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: upload-data
          emptyDir: {}
          # Note: Using emptyDir - uploads will be lost on pod restart
          # For production, configure a storage provisioner
